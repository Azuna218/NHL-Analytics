---
title: "NHL Players Analysis"
author: "Francesco Sebastian"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---

Load libraries

```{r setup, include=TRUE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(shiny)
```

Load Datasets

```{r}
# Load datasets
teams <- read.csv("nhl_teams.csv")
rosters <- read.csv("nhl_rosters.csv")
player.birth <- read.csv("nhl_player_births.csv")
canada.birth <- read.csv("canada_births_1991_2022.csv")

# Display the first few rows of each dataset
head(teams)
head(rosters)
head(player.birth)
head(canada.birth)
```

Trends of Births in Canada (1991-2022)

```{r}
# Grouping the birth by year
yearly_births <- aggregate(canada.birth$births, by = list(canada.birth$year), FUN = sum)
colnames(yearly_births) <- c('Year', 'Total_Births')

# Plotting the trend of births
ggplot(yearly_births, aes(x = Year, y = Total_Births)) +
  geom_line(color = 'blue') +
  ggtitle("Trend of Births in Canada (1991-2022)") +
  xlab("Year") + ylab("Total Births") +
  scale_x_continuous(breaks = seq(1990, 2025, by = 5))


```

NHL Player Birthplace Analysis

```{r}
# Count the number of players by birth province
player_count_by_province <- player.birth %>%
  group_by(birth_state_province) %>%
  summarise(total_players = n()) %>%
  arrange(desc(total_players))

# Removing NA values 
player_count_by_province <- na.omit(player_count_by_province)

# Plotting the top provinces producing NHL players
ggplot(player_count_by_province, aes(x = reorder(birth_state_province, -total_players), y = total_players)) +
  geom_bar(stat = 'identity', fill = 'darkgreen') +
  coord_flip() +
  ggtitle("NHL Players by Canadian Province") +
  xlab("Province") + ylab("Number of NHL Players")

```

Comparison of NHL Teams Success and Birth Locations

```{r}
# Merge player data with team data
nhl_data <- merge(rosters, teams, by = "team_code")
nhl_data <- na.omit(nhl_data)

# Analyze NHL teams and birthplaces of players
team_birth_count <- nhl_data %>%
  group_by(team_code, birth_country) %>%
  summarise(total_players = n()) %>%
  arrange(desc(total_players))

team_birth_count <- merge(team_birth_count, teams, by = "team_code")

# Plot number of players by birth country for each NHL team
ggplot(team_birth_count, aes(x = reorder(full_name, -total_players), y = total_players, fill = birth_country)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  ggtitle("NHL Teams and Players' Birth Countries") +
  xlab("NHL Team") + ylab("Number of Players") +
  labs(fill = "Birth Country") +
  theme(legend.position = "bottom")

```

Shiny Application for NHL Players Analysis

```{r}
# Define UI
ui <- fluidPage(
  titlePanel("NHL Players Analysis"),
  
  sidebarLayout(
    sidebarPanel(
      selectInput("birth_country", "Select Birth Country:", 
                  choices = unique(nhl_data$birth_country), 
                  selected = unique(nhl_data$birth_country)[1]),
      sliderInput("height", "Height (inches):", 
                  min = min(nhl_data$height_in_inches), 
                  max = max(nhl_data$height_in_inches), 
                  value = c(65, 75)),
      sliderInput("weight", "Weight (pounds):", 
                  min = min(nhl_data$weight_in_pounds), 
                  max = max(nhl_data$weight_in_pounds), 
                  value = c(150, 250)),
      actionButton("predict", "Predict Player Class")
    ),
    
    mainPanel(
      plotOutput("heightWeightPlot"),
      verbatimTextOutput("predictionResult")
    )
  )
)

# Define server logic
server <- function(input, output) {
  
  # Create a reactive dataset based on user input
  filtered_data <- reactive({
    nhl_data[nhl_data$birth_country == input$birth_country & 
               nhl_data$height_in_inches >= input$height[1] & 
               nhl_data$height_in_inches <= input$height[2] &
               nhl_data$weight_in_pounds >= input$weight[1] & 
               nhl_data$weight_in_pounds <= input$weight[2], ]
  })
  
  # Plot height vs weight
  output$heightWeightPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = height_in_inches, y = weight_in_pounds)) +
      geom_point(aes(color = birth_country), alpha = 0.5) +
      labs(title = "Height vs Weight of NHL Players",
           x = "Height (inches)",
           y = "Weight (pounds)") +
      theme_minimal()
  })
  
  # Prediction logic
  observeEvent(input$predict, {
    new_data <- data.frame(
      height_in_inches = mean(input$height),
      weight_in_pounds = mean(input$weight),
      birth_country = input$birth_country
    )
    
    # Ensure the birth_country factor levels match the model
    new_data$birth_country <- factor(new_data$birth_country, levels = levels(nhl_data$birth_country))
    
    # Predict the player class using the model (assuming it's already trained)
    predicted_probabilities <- predict(model, newdata = new_data, type = "response")
    predicted_class <- ifelse(predicted_probabilities > 0.5, "Forward", "Defense/Goalie")  # Adjust according to your class names
    
    output$predictionResult <- renderPrint({
      paste("Predicted Player Class:", predicted_class)
    })
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

Clustering Analysis of NHL Players

```{r}
# Prepare data for clustering
clustering_data <- nhl_data[, c("height_in_centimeters", "weight_in_kilograms")]

# Normalize the data
clustering_data_scaled <- scale(clustering_data)

# Calculate total within-cluster sum of squares for different k values
wcss <- sapply(1:10, function(k) {
  kmeans(clustering_data_scaled, centers = k, nstart = 10)$tot.withinss
})

# Plot the Elbow Method
plot(1:10, wcss, type = "b", pch = 19, frame = FALSE,
     xlab = "Number of Clusters",
     ylab = "Total Within-Cluster Sum of Squares")

# Fit K-Means with the optimal number of clusters
set.seed(42)
kmeans_result <- kmeans(clustering_data_scaled, centers = 2, nstart = 10)

# Add cluster assignment to the original data
nhl_data$cluster <- as.factor(kmeans_result$cluster)

# Visualize Clusters
ggplot(nhl_data, aes(x = height_in_centimeters, y = weight_in_kilograms, color = cluster)) +
  geom_point(size = 3) +
  ggtitle("K-Means Clustering of NHL Players") +
  xlab("Height (Centimeters)") + 
  ylab("Weight (Kilograms)")

```
